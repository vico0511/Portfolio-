<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio | Victor Lesur</title>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { 
            animation: fadeIn 0.4s ease-out forwards; 
        }
        select { cursor: pointer; appearance: none; }
        
        /* Style pour la scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #0071e3; }

        /* Style sp√©cifique pour les checkboxes transform√©es en boutons */
        .type-checkbox:checked + span {
            background-color: #0071e3;
            color: white;
            border-color: #0071e3;
            box-shadow: 0 0 15px rgba(0, 113, 227, 0.4);
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); border-color: rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 113, 227, 0); border-color: rgba(255, 255, 255, 0.7); }
            100% { box-shadow: 0 0 0 0 rgba(0, 113, 227, 0); border-color: rgba(255, 255, 255, 0.7); }
        }

        .animate-pulse-white {
            animation: pulse-border 2s infinite;
        }

        /* Couleur de s√©lection sp√©cifique pour √âtudes */
        .type-checkbox[value="formation"]:checked + span {
            background-color: rgba(16, 185, 129, 0.2); /* emerald-500 √† 20% */
            color: #34d399; /* emerald-400 */
            border-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        /* Couleur de s√©lection sp√©cifique pour Jobs */
        .type-checkbox[value="job"]:checked + span {
            background-color: rgba(245, 158, 11, 0.2); /* amber-500 √† 20% */
            color: #fbbf24; /* amber-400 */
            border-color: #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }
        
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'apple-blue': '#0071e3',
                        'dark-bg': '#1a1a1a',
                        'light-text': '#f5f5f7',
                        'filter-panel': '#242426',
                    }
                }
            }
        }

    </script>
</head>
<body class="bg-dark-bg text-light-text font-sans selection:bg-apple-blue selection:text-white">

    <header class="sticky top-0 z-50 bg-dark-bg/80 backdrop-blur-md border-b border-white/10 px-4 md:px-8 py-4 md:py-6">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4 md:gap-6">
            <div class="text-center md:text-left">
                <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white uppercase italic">
                    Victor <span class="text-apple-blue not-italic">Lesur</span>
                </h1>
                <div class="flex items-center justify-center md:justify-start gap-2 mt-1">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    <p class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest">Data Science & Analytics</p>
                </div>
            </div>

            <nav class="flex items-center gap-2 md:gap-3 bg-white/5 p-1.5 rounded-2xl border border-white/10 w-full md:w-auto justify-center">
                <a href="cv_page.html" class="flex items-center gap-2 px-3 py-2 rounded-xl text-xs md:text-sm font-bold transition-all hover:bg-white/10 hover:text-apple-blue whitespace-nowrap">
                    Mon CV
                </a>
                <a href="https://www.linkedin.com/in/victor--lesur/" target="_blank" class="flex items-center gap-2 px-3 py-2 rounded-xl text-xs md:text-sm font-bold transition-all hover:bg-[#0077b5]/10 hover:text-[#0077b5] whitespace-nowrap">
                    LinkedIn
                </a>
                <a href="contact.html" class="border border-apple-blue/50 hover:bg-apple-blue text-white px-4 py-2 rounded-xl text-xs md:text-sm font-bold transition-all whitespace-nowrap">
                    Me Contacter
                </a>
            </nav>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
    
        <div class="bg-filter-panel border border-white/10 rounded-3xl p-5 md:p-8 mb-8 shadow-2xl relative overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div class="bg-apple-blue/20 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-apple-blue" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <h2 class="text-white/90 uppercase text-[10px] md:text-xs font-bold tracking-[0.2em]">Filtres</h2>
                </div>
                <button id="reset-btn" class="text-xs font-bold text-gray-500 hover:text-white transition-colors flex items-center gap-1">
                    Effacer
                </button>
            </div>

            <div class="space-y-6">
                <div>
                    <div class="flex flex-wrap gap-2">
                        <label class="cursor-pointer flex-1 md:flex-none group">
                            <input type="checkbox" value="pro" class="type-checkbox hidden">
                            <span class="text-center px-4 py-2.5 rounded-xl border border-white/10 bg-white/5 text-sm font-semibold transition-all block hover:border-apple-blue/50 hover:bg-apple-blue/10 hover:text-apple-blue whitespace-nowrap">
                                üíº Pro
                            </span>
                        </label>

                        <label class="cursor-pointer flex-1 md:flex-none group">
                            <input type="checkbox" value="formation" class="type-checkbox hidden">
                            <span class="text-center px-4 py-2.5 rounded-xl border border-white/10 bg-white/5 text-sm font-semibold transition-all block hover:border-emerald-500/50 hover:bg-emerald-500/10 hover:text-emerald-400 whitespace-nowrap">
                                üéì √âtudes
                            </span>
                        </label>

                        <label class="cursor-pointer flex-1 md:flex-none group">
                            <input type="checkbox" value="job" class="type-checkbox hidden">
                            <span class="text-center px-4 py-2.5 rounded-xl border border-white/10 bg-white/5 text-sm font-semibold transition-all block hover:border-amber-500/50 hover:bg-amber-500/10 hover:text-amber-400 whitespace-nowrap">
                                üõ†Ô∏è Jobs
                            </span>
                        </label>
                    </div>
                </div>

                <button onclick="document.getElementById('advanced-filters').classList.toggle('hidden')" class="w-full md:hidden py-2 text-[10px] font-black uppercase tracking-widest text-gray-500 border-t border-white/5 pt-4">
                    Affiner la recherche ‚ñº
                </button>

                <div id="advanced-filters" class="hidden md:grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative group">
                        <label class="block text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">Exp√©rience</label>
                        <select id="filter-exp" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-xs text-white appearance-none">
                            <option value="all">Toutes</option>
                        </select>
                    </div>
                    <div class="relative group">
                        <label class="block text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">Projet</label>
                        <select id="filter-proj" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-xs text-white appearance-none">
                            <option value="all">Tous</option>
                        </select>
                    </div>
                    <div class="relative group">
                        <label class="block text-[9px] font-black text-gray-500 uppercase tracking-widest mb-2">Skill</label>
                        <select id="filter-skill" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-xs text-white appearance-none">
                            <option value="all">Toutes</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="filter-counter" class="mt-6 pt-4 border-t border-white/5 grid grid-cols-3 gap-4 items-center">
                </div>
        </div>

        <section id="projets" class="overflow-hidden">
            <div id="experience-details"></div>
            <div id="results-container" class="space-y-6"></div>
        </section>
    </main>

<script>
    let portfolioData = {};

    async function init() {
        try {
            const response = await fetch('data.json');
            portfolioData = await response.json();
            setupFilters();
            
            document.getElementById('reset-btn').addEventListener('click', resetAllFilters);
            document.querySelectorAll('.type-checkbox').forEach(cb => {
                cb.addEventListener('change', () => { updateURL(); render(); });
            });
            ['filter-exp', 'filter-proj', 'filter-skill'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    validateSelections(id);
                    updateURL(); 
                    render(); 
                });
            });
            document.getElementById('results-container').addEventListener('click', handleGlobalClick);

            loadFiltersFromURL();
            render(); 
        } catch (e) { 
            console.error("Erreur chargement donn√©es", e);
            document.getElementById('results-container').innerHTML = `
                <div class="text-center p-10 bg-red-500/10 border border-red-500/20 rounded-2xl animate-fade-in">
                    <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <p class="text-red-400 font-bold">D√©sol√©, impossible de charger les projets.</p>
                    <p class="text-gray-500 text-sm mt-2">V√©rifiez que le fichier data.json est bien pr√©sent √† la racine.</p>
                </div>`;
        }
    }

    function setupFilters() {
        const fill = (id, items, key) => {
            const select = document.getElementById(id);
            const firstOptText = select.options[0].textContent;
            select.innerHTML = `<option value="all">${firstOptText}</option>`;
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item[key] || item.nom || item.titre;
                select.appendChild(opt);
            });
        };
        fill('filter-exp', portfolioData.experiences, 'titre');
        fill('filter-proj', portfolioData.projets, 'titre');
        fill('filter-skill', portfolioData.competences, 'nom');
    }

    function validateSelections(changedFilterId) {
        const expVal = document.getElementById('filter-exp').value;
        const projVal = document.getElementById('filter-proj').value;
        if (changedFilterId === 'filter-exp' && expVal !== 'all' && projVal !== 'all') {
            const proj = portfolioData.projets.find(p => p.id === projVal);
            if (proj && proj.exp_id !== expVal) document.getElementById('filter-proj').value = 'all';
        }
    }

    function handleGlobalClick(e) {
        const expCard = e.target.closest('[data-exp-id]');
        if (expCard) {
            const expId = expCard.getAttribute('data-exp-id');
            document.getElementById('filter-exp').value = expId;
            document.getElementById('filter-proj').value = 'all';
            updateURL(); render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }
        const tag = e.target.closest('[data-skill-id]');
        if (tag) {
            const skillId = tag.getAttribute('data-skill-id');
            document.getElementById('filter-skill').value = skillId;
            updateURL(); render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function updateURL() {
        const params = new URLSearchParams();
        const checkedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
        if (checkedTypes.length > 0) params.set('types', checkedTypes.join(','));
        const exp = document.getElementById('filter-exp').value;
        const proj = document.getElementById('filter-proj').value;
        const skill = document.getElementById('filter-skill').value;
        if (exp !== 'all') params.set('exp', exp);
        if (proj !== 'all') params.set('proj', proj);
        if (skill !== 'all') params.set('skill', skill);
        history.pushState(null, '', window.location.pathname + (params.toString() ? '?' + params.toString() : ''));
    }

    function loadFiltersFromURL() {
        const params = new URLSearchParams(window.location.search);
        
        // 1. D'ABORD, on r√©initialise tout par d√©faut
        document.querySelectorAll('.type-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('filter-exp').value = 'all';
        document.getElementById('filter-proj').value = 'all';
        document.getElementById('filter-skill').value = 'all';

        // 2. ENSUITE, on applique ce qu'il y a dans l'URL
        if (params.has('types')) {
            const types = params.get('types').split(',');
            document.querySelectorAll('.type-checkbox').forEach(cb => { 
                if (types.includes(cb.value)) cb.checked = true; 
            });
        }
        if (params.has('exp')) document.getElementById('filter-exp').value = params.get('exp');
        if (params.has('proj')) document.getElementById('filter-proj').value = params.get('proj');
        if (params.has('skill')) document.getElementById('filter-skill').value = params.get('skill');
    }

    function resetAllFilters() {
        document.querySelectorAll('.type-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('filter-exp').value = 'all';
        document.getElementById('filter-proj').value = 'all';
        document.getElementById('filter-skill').value = 'all';
        updateURL(); render();
    }

    function updateDropdownVisibility(validExpIds, validProjIds, validSkillIds) {
        const updateOptions = (selectId, validIds) => {
            const select = document.getElementById(selectId);
            Array.from(select.options).forEach(opt => {
                if (opt.value === 'all') return;
                const isValid = validIds.includes(opt.value);
                opt.hidden = !isValid;
                opt.disabled = !isValid;
                if (!isValid && select.value === opt.value) select.value = 'all';
            });
        };
        updateOptions('filter-exp', validExpIds);
        updateOptions('filter-proj', validProjIds);
        updateOptions('filter-skill', validSkillIds);
    }

    // --- MISE A JOUR DU COMPTEUR ESTHETIQUE ---
    function updateCounterVisual(totalProjs, currentProjs, totalExps, currentExps) {
        const percent = totalProjs > 0 ? Math.round((currentProjs / totalProjs) * 100) : 0;
        
        // Changement : On utilise flex-col sur mobile pour tout centrer, et flex-row sur PC
        const html = `
            <div class="col-span-full flex flex-col md:flex-row items-center justify-between gap-6">
                
                <div class="flex items-center justify-center gap-8 w-full md:w-auto">
                    <div class="flex flex-col items-center md:items-start">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-1">Exp√©riences</span>
                        <span class="text-2xl font-black text-white">${currentExps}<span class="text-sm text-gray-500 font-normal">/${totalExps}</span></span>
                    </div>
                    <div class="h-8 w-px bg-white/10 hidden md:block"></div> <div class="flex flex-col items-center md:items-start">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-1">Projets</span>
                        <span class="text-2xl font-black text-apple-blue">${currentProjs}<span class="text-sm text-gray-500 font-normal"> Visibles</span></span>
                    </div>
                </div>

                <div class="flex-1 w-full max-w-md">
                    <div class="flex justify-between text-[9px] font-black uppercase tracking-[0.2em] mb-2">
                        <span class="text-gray-500">Progression de la s√©lection</span>
                        <span class="text-apple-blue">${percent}%</span>
                    </div>
                    <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-blue-600 to-apple-blue rounded-full transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(0,113,227,0.3)]" 
                            style="width: ${percent}%">
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('filter-counter').innerHTML = html;
    }

    function render() {
        const checkedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
        const fExp = document.getElementById('filter-exp').value;
        const fProj = document.getElementById('filter-proj').value;
        const fSkill = document.getElementById('filter-skill').value;

        let validExps = portfolioData.experiences.filter(e => checkedTypes.length === 0 || checkedTypes.includes(e.type));
        
        let validProjs = portfolioData.projets.filter(p => {
            const belongToValidExp = validExps.some(e => e.id === p.exp_id);
            const matchExpFilter = fExp === 'all' || p.exp_id === fExp;
            const matchSkillFilter = fSkill === 'all' || p.skills.includes(fSkill);
            return belongToValidExp && matchExpFilter && matchSkillFilter;
        });

        let validSkillIds = [...new Set(validProjs.flatMap(p => p.skills))];

        if (fSkill !== 'all') {
             const expIdsWithSkill = validProjs.map(p => p.exp_id);
             validExps = validExps.filter(e => expIdsWithSkill.includes(e.id));
        }

        updateDropdownVisibility(validExps.map(e => e.id), validProjs.map(p => p.id), validSkillIds);

        const container = document.getElementById('results-container');
        const expDetailsContainer = document.getElementById('experience-details');
        
        container.innerHTML = '';
        expDetailsContainer.innerHTML = '';

        const isDefaultView = fExp === 'all' && fProj === 'all' && fSkill === 'all';

        if (isDefaultView) {
            renderPanorama(container, validExps);
        } else {
            renderFilteredView(fExp, fProj, fSkill, container, expDetailsContainer, validExps, validProjs);
        }

        updateCounterVisual(portfolioData.projets.length, validProjs.length, portfolioData.experiences.length, validExps.length);
    }

    // --- RENDU PANORAMA AVEC LIMITATION > 3 PROJETS ---
    function renderPanorama(container, list) {
        const styles = {
            pro: { border: 'border-blue-500/50', bg: 'bg-blue-500/5', text: 'text-blue-400', badge: 'border-blue-500', icon: 'üíº' },
            formation: { border: 'border-emerald-500/50', bg: 'bg-emerald-500/5', text: 'text-emerald-400', badge: 'border-emerald-500', icon: 'üéì' },
            job: { border: 'border-amber-500/50', bg: 'bg-amber-500/5', text: 'text-amber-400', badge: 'border-amber-500', icon: 'üõ†Ô∏è' }
        };

        list.forEach(exp => {
            const s = styles[exp.type] || styles.pro;
            const projs = portfolioData.projets.filter(p => p.exp_id === exp.id);
            
            // --- LOGIQUE DE FUSION DES COMP√âTENCES ---
            // 1. On r√©cup√®re les skills des projets
            const projSkillIds = projs.flatMap(p => p.skills);
            // 2. On r√©cup√®re les comp√©tences cl√©s de l'exp√©rience (si elles existent)
            const expKeySkillIds = exp.competences_cles || [];
            // 3. On fusionne et on utilise Set pour supprimer les doublons
            const allSkillIds = [...new Set([...projSkillIds, ...expKeySkillIds])];
            
            const DISPLAY_LIMIT = 3;
            const visibleProjs = projs.slice(0, DISPLAY_LIMIT);
            const remainingCount = projs.length - DISPLAY_LIMIT;

            // G√©n√©ration des badges (on en affiche jusqu'√† 6 pour ne pas encombrer)
            const skillBadges = allSkillIds.slice(0, 6).map(sid => {
                const sk = portfolioData.competences.find(c => c.id === sid);
                return sk ? `<span class="text-[9px] md:text-[10px] px-2 py-0.5 bg-white/5 border border-white/10 rounded text-gray-400 group-hover:border-white/30 transition-colors">${sk.nom}</span>` : '';
            }).join('');

            container.innerHTML += `
                <div data-exp-id="${exp.id}" class="group cursor-pointer bg-gray-800/40 p-4 md:p-8 rounded-2xl border-l-8 ${s.border} ${s.bg} animate-fade-in mb-6 transition-all hover:translate-x-1 md:hover:translate-x-2 hover:bg-gray-800/60 shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-6 gap-4">
                        <div class="flex gap-4 items-center">
                            <span class="text-2xl md:text-3xl">${s.icon}</span>
                            <div>
                                <span class="text-[10px] px-2 py-0.5 rounded border ${s.badge} ${s.text} uppercase font-bold tracking-widest">${exp.type}</span>
                                <h3 class="text-lg md:text-2xl font-bold text-white mt-1 group-hover:text-apple-blue transition-colors break-words">
                                    ${exp.titre}
                                </h3>
                            </div>
                        </div>
                        <div class="text-left md:text-right w-full md:w-auto">
                            <span class="${s.text} font-mono font-bold block text-sm md:text-base">${exp.periode || ''}</span>
                            <span class="text-[10px] text-gray-500 uppercase font-bold mt-1 block italic opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity tracking-widest">Voir D√©tails ‚Üí</span>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 md:gap-8 pointer-events-none opacity-90 md:opacity-80 group-hover:opacity-100 transition-opacity">
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase mb-3 font-bold tracking-widest">R√©alisations principales</p>
                            <ul class="space-y-2 text-sm text-gray-300">
                                ${visibleProjs.length > 0 
                                    ? visibleProjs.map(p => `<li class="flex items-center"><span class="w-1.5 h-1.5 flex-shrink-0 ${s.text.replace('text', 'bg')} rounded-full mr-3"></span><span class="truncate">${p.titre}</span></li>`).join('')
                                    : `<li class="italic text-gray-500 text-xs">Consulter les d√©tails de l'exp√©rience</li>`
                                }
                            </ul>
                            ${remainingCount > 0 ? `
                                <div class="mt-3">
                                    <span class="px-2 py-1 rounded bg-white/10 text-[10px] font-bold text-white border border-white/20">
                                        + ${remainingCount} autres missions
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase mb-3 font-bold tracking-widest">Expertise & Soft Skills</p>
                            <div class="flex flex-wrap gap-2">${skillBadges}</div>
                        </div>
                    </div>
                </div>`;
        });
    }

        function renderFilteredView(fExp, fProj, fSkill, container, expDetailsContainer, validExps, validProjs) {
        expDetailsContainer.innerHTML = `
            <button onclick="resetAllFilters()" class="mb-6 flex items-center gap-2 text-apple-blue hover:text-white transition-all font-bold text-sm group">
                <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> Retour √† la vue d'ensemble
            </button>`;

        // 1. Affichage de l'en-t√™te de l'exp√©rience
        if (fExp !== 'all') {
            const exp = portfolioData.experiences.find(e => e.id === fExp);
            if (exp) {
                const color = exp.type === 'formation' ? 'text-emerald-400' : (exp.type === 'job' ? 'text-amber-400' : 'text-apple-blue');
                
                // ... (garde ton code ici pour g√©n√©rer le HTML de l'exp√©rience : resume, details_complets, etc.)
                
                expDetailsContainer.innerHTML += `
                    <div class="bg-gray-800 p-6 md:p-8 rounded-3xl border border-white/10 animate-fade-in mb-8 shadow-2xl relative overflow-hidden">
                        <div class="hidden md:block absolute top-0 right-0 p-8 text-8xl opacity-5 font-black uppercase italic select-none pointer-events-none">${exp.type}</div>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-white relative z-10">${exp.titre}</h2>
                        <p class="${color} mt-1 font-mono font-bold uppercase text-xs md:text-sm tracking-widest relative z-10">${exp.periode || ''}</p>
                        <p class="text-gray-300 mt-6 leading-relaxed text-sm md:text-base border-l-4 border-apple-blue pl-4 italic max-w-4xl">
                            ${exp.resume || 'Aucun r√©sum√© disponible.'}
                        </p>
                        ${exp.details_complets ? `
                            <button onclick="toggleDetails(event)" id="btn-toggle-exp"
                                    class="mt-6 flex items-center gap-2 px-4 py-2 bg-apple-blue/10 border border-apple-blue/30 rounded-full text-[10px] font-black uppercase tracking-tighter text-white transition-all hover:bg-apple-blue animate-pulse-white group">
                                <span id="btn-text">D√©tails Mission</span>
                                <svg id="btn-icon" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div id="more-details" class="hidden mt-6 pt-6 border-t border-white/5 text-gray-400 text-sm leading-relaxed animate-fade-in">
                                ${exp.details_complets}
                            </div>` : ''}
                    </div>
                    <h3 class="text-white/50 uppercase text-[10px] font-black tracking-[0.3em] mb-6 ml-2">Missions & R√©alisations</h3>`;
            }
        }

        // 2. Affichage des projets li√©s
        if (validProjs.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500 py-12 italic">Aucun projet ne correspond.</div>`;
        } else {
            validProjs.forEach(proj => {
                // CRUCIAL : Si un projet sp√©cifique est s√©lectionn√© dans le filtre, on n'affiche que lui
                if (fProj !== 'all' && proj.id !== fProj) return;

                const parentExp = portfolioData.experiences.find(e => e.id === proj.exp_id);
                let borderClass = parentExp.type === 'formation' ? 'border-emerald-500' : (parentExp.type === 'job' ? 'border-amber-500' : 'border-apple-blue');

                container.innerHTML += `
                    <div class="bg-gray-800/60 p-5 md:p-8 rounded-2xl border-l-4 ${borderClass} shadow-lg animate-fade-in mb-6 group">
                        <h4 class="text-lg md:text-xl font-bold mb-3 text-white group-hover:text-apple-blue transition-colors">${proj.titre}</h4>
                        <div class="text-gray-300 mb-4 text-sm md:text-base leading-relaxed">
                            ${proj.description ? proj.description.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>') : ''}
                        </div>
                        ${proj.details_projet ? `
                            <button onclick="toggleProjectDetails('${proj.id}')" class="mb-4 inline-flex items-center gap-2 py-1 text-[10px] font-black uppercase tracking-widest text-apple-blue border-b border-apple-blue/0 hover:border-apple-blue transition-all">
                                <span id="btn-project-text-${proj.id}">D√©tails de la mission</span>
                                <svg id="btn-project-icon-${proj.id}" class="h-3 w-3 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <div id="project-details-${proj.id}" class="hidden mb-4 p-4 bg-black/20 rounded-xl text-gray-400 text-xs md:text-sm animate-fade-in">
                                ${proj.details_projet}
                            </div>` : ''}
                        <div class="flex flex-wrap gap-2">
                            ${proj.skills.map(s => {
                                const sk = portfolioData.competences.find(c => c.id === s);
                                return `<span class="text-[9px] md:text-[10px] px-2 py-1 bg-white/5 border border-white/10 rounded text-gray-400">${sk ? sk.nom : s}</span>`;
                            }).join('')}
                        </div>
                    </div>`;
            });
        }
    }
    function toggleDetails() {
        const detailDiv = document.getElementById('more-details');
        const btnText = document.getElementById('btn-text');
        const btnIcon = document.getElementById('btn-icon');
        const btn = event.currentTarget; // R√©cup√®re le bouton cliqu√©

        if (detailDiv.classList.contains('hidden')) {
            detailDiv.classList.remove('hidden');
            btnText.textContent = "Fermer";
            btnIcon.classList.add('rotate-180');
            btn.classList.remove('animate-pulse-white'); // On arr√™te de clignoter quand c'est ouvert
        } else {
            detailDiv.classList.add('hidden');
            btnText.textContent = "D√©tails Mission";
            btnIcon.classList.remove('rotate-180');
            btn.classList.add('animate-pulse-white'); // On recommence √† clignoter
        }
    }
    function toggleProjectDetails(projectId) {
        const detailDiv = document.getElementById(`project-details-${projectId}`);
        const btnText = document.getElementById(`btn-project-text-${projectId}`);
        const btnIcon = document.getElementById(`btn-project-icon-${projectId}`);

        if (detailDiv.classList.contains('hidden')) {
            detailDiv.classList.remove('hidden');
            btnText.textContent = "Fermer";
            btnIcon.classList.add('rotate-180');
        } else {
            detailDiv.classList.add('hidden');
            btnText.textContent = "D√©tails de la mission";
            btnIcon.classList.remove('rotate-180');
        }
    }
    init();
    // Cet √©couteur surveille le bouton "Pr√©c√©dent"
    window.addEventListener('popstate', () => {
        // 1. On relit les filtres qui sont maintenant dans l'URL
        loadFiltersFromURL(); 
        // 2. On redessine la page avec ces filtres
        render(); 
    });
</script>
</body>
</html>